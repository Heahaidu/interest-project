{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "All-in-one microservices optimized: Dynamic ECR Images based on AccountID, Region, ProjectName and ServiceName.",
  "Metadata": {
    "_comment_00": "Optimized parameters for ECR images."
  },
  "Parameters": {
    "BootstrapMode": {
      "Type": "String",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Default": "true",
      "Description": "Set to 'true' to use a lightweight bootstrap image for initial deployment. Set to 'false' to use your real ECR images after they are pushed."
    },
    "BootstrapImage": {
      "Type": "String",
      "Default": "heahaidu/springboot-health-bootstrap:latest",
      "Description": "The public Docker Hub image used to bypass initial ECR pull failures."
    },
    "ProjectName": {
      "Type": "String",
      "Default": "interest"
    },
    "ScanOnPush": {
      "Type": "String",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Default": "true",
      "Description": "Enable scan on push to have each image automatically scanned after being pushed to a repository. If disabled, each image scan must be manually started to get scan results."
    },
    "ImageTagMutability": {
      "Type": "String",
      "AllowedValues": [
        "MUTABLE",
        "IMMUTABLE"
      ],
      "Default": "MUTABLE"
    },
    "VpcCidr": {
      "Type": "String",
      "Default": "10.0.0.0/16"
    },
    "PublicSubnet1Cidr": {
      "Type": "String",
      "Default": "10.0.0.0/24"
    },
    "PublicSubnet2Cidr": {
      "Type": "String",
      "Default": "10.0.1.0/24"
    },
    "PrivateSubnet1Cidr": {
      "Type": "String",
      "Default": "10.0.10.0/24"
    },
    "PrivateSubnet2Cidr": {
      "Type": "String",
      "Default": "10.0.11.0/24"
    },
    "ImagesBucketName": {
      "Type": "String",
      "Default": "interest-s3-object"
    },
    "WebBucketName": {
      "Type": "String",
      "Default": "interest-s3-app"
    },
    "GitHubOrg": {
      "Type": "String",
      "Default": "Heahaidu"
    },
    "GitHubRepo": {
      "Type": "String",
      "Default": "interest-project"
    },
    "GitHubBranch": {
      "Type": "String",
      "Default": "main"
    },
    "MailHost": {
      "Type": "String",
      "Default": "smtp.gmail.com"
    },
    "MailUsername": {
      "Type": "String",
      "Default": "truongchuong20@gmail.com"
    },
    "MailPassword": {
      "Type": "String",
      "NoEcho": true,
      "MinLength": 8,
      "Description": "Email SMTP password / app password"
    },
    "DbUsername": {
      "Type": "String",
      "Default": "administrator"
    },
    "DbPassword": {
      "Type": "String",
      "NoEcho": true,
      "MinLength": 8
    },
    "DbPort": {
      "Type": "Number",
      "Default": 5432
    },
    "DbInstanceClass": {
      "Type": "String",
      "Default": "db.t4g.small"
    },
    "DbAllocatedStorage": {
      "Type": "Number",
      "Default": 20
    },
    "DbMultiAZ": {
      "Type": "String",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Default": "false"
    },
    "ContainerPort": {
      "Type": "Number",
      "Default": 8080
    },
    "ServiceAName": {
      "Type": "String",
      "Default": "user"
    },
    "ServiceBName": {
      "Type": "String",
      "Default": "notification",
      "Description": "Service B will have the same RDS with Service C"
    },
    "ServiceCName": {
      "Type": "String",
      "Default": "chatbot",
      "Description": "Service C will have the same RDS with Service B"
    },
    "ServiceDName": {
      "Type": "String",
      "Default": "event"
    },
    "EcrRegion": {
      "Type": "String",
      "Default": "us-east-1",
      "Description": "The AWS Region (Zone) where your ECR repositories are located."
    },
    "ImageTag": {
      "Type": "String",
      "Default": "latest",
      "Description": "The tag of the docker image to deploy (e.g., latest, v1.0.0, sha-xyz)."
    },
    "ServiceAPaths": {
      "Type": "CommaDelimitedList",
      "Default": "/api/v1/user/*,/api/v1/user"
    },
    "ServiceBPaths": {
      "Type": "CommaDelimitedList",
      "Default": "/api/v1/notifications/*,/api/v1/notifications"
    },
    "ServiceCPaths": {
      "Type": "CommaDelimitedList",
      "Default": "/ws-chat/websocket/*,/api/v1/chatbot/*,/api/v1/chatbot"
    },
    "ServiceDPaths": {
      "Type": "CommaDelimitedList",
      "Default": "/api/v1/events/*,/api/v1/events"
    },
    "HealthCheckPath": {
      "Type": "String",
      "Default": "/actuator/health/liveness"
    },
    "DesiredCountA": {
      "Type": "Number",
      "Default": 1
    },
    "DesiredCountB": {
      "Type": "Number",
      "Default": 1
    },
    "DesiredCountC": {
      "Type": "Number",
      "Default": 1
    },
    "DesiredCountD": {
      "Type": "Number",
      "Default": 1
    },
    "AutoScaleMin": {
      "Type": "Number",
      "Default": 1
    },
    "AutoScaleMax": {
      "Type": "Number",
      "Default": 4
    },
    "AutoScaleCpuTarget": {
      "Type": "Number",
      "Default": 60.0
    }
  },
  "Conditions": {
    "IsMultiAZ": {
      "Fn::Equals": [
        {
          "Ref": "DbMultiAZ"
        },
        "true"
      ]
    },
    "DoScanOnPush": {
      "Fn::Equals": [
        {
          "Ref": "ScanOnPush"
        },
        "true"
      ]
    },
    "IsBootstrapMode": {
      "Fn::Equals": [
        {
          "Ref": "BootstrapMode"
        },
        "true"
      ]
    }
  },
  "Resources": {
    "EcrRepoA": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {
          "Fn::Sub": "${ProjectName}-${ServiceAName}-images"
        },
        "ImageTagMutability": {
          "Ref": "ImageTagMutability"
        },
        "ImageScanningConfiguration": {
          "ScanOnPush": {
            "Fn::If": [
              "DoScanOnPush",
              true,
              false
            ]
          }
        },
        "EncryptionConfiguration": {
          "EncryptionType": "AES256"
        }
      }
    },
    "EcrRepoB": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {
          "Fn::Sub": "${ProjectName}-${ServiceBName}-images"
        },
        "ImageTagMutability": {
          "Ref": "ImageTagMutability"
        },
        "ImageScanningConfiguration": {
          "ScanOnPush": {
            "Fn::If": [
              "DoScanOnPush",
              true,
              false
            ]
          }
        },
        "EncryptionConfiguration": {
          "EncryptionType": "AES256"
        }
      }
    },
    "EcrRepoC": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {
          "Fn::Sub": "${ProjectName}-${ServiceCName}-images"
        },
        "ImageTagMutability": {
          "Ref": "ImageTagMutability"
        },
        "ImageScanningConfiguration": {
          "ScanOnPush": {
            "Fn::If": [
              "DoScanOnPush",
              true,
              false
            ]
          }
        },
        "EncryptionConfiguration": {
          "EncryptionType": "AES256"
        }
      }
    },
    "EcrRepoD": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {
          "Fn::Sub": "${ProjectName}-${ServiceDName}-images"
        },
        "ImageTagMutability": {
          "Ref": "ImageTagMutability"
        },
        "ImageScanningConfiguration": {
          "ScanOnPush": {
            "Fn::If": [
              "DoScanOnPush",
              true,
              false
            ]
          }
        },
        "EncryptionConfiguration": {
          "EncryptionType": "AES256"
        }
      }
    },
    "Vpc": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr"
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-vpc"
            }
          }
        ]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway"
    },
    "AttachIgw": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "CidrBlock": {
          "Ref": "PublicSubnet1Cidr"
        },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-public-a"
            }
          }
        ]
      }
    },
    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "CidrBlock": {
          "Ref": "PublicSubnet2Cidr"
        },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-public-b"
            }
          }
        ]
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "CidrBlock": {
          "Ref": "PrivateSubnet1Cidr"
        },
        "MapPublicIpOnLaunch": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-private-a"
            }
          }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "CidrBlock": {
          "Ref": "PrivateSubnet2Cidr"
        },
        "MapPublicIpOnLaunch": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-private-b"
            }
          }
        ]
      }
    },
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },
    "PublicDefaultRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "AttachIgw",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "PublicSubnet1Assoc": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PublicSubnet1"
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      }
    },
    "PublicSubnet2Assoc": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PublicSubnet2"
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      }
    },
    "NatEip1": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "NatEip2": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "NatGateway1": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "PublicSubnet1"
        }
      }
    },
    "NatGateway2": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip2",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "PublicSubnet2"
        }
      }
    },
    "PrivateRouteTable1": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },
    "PrivateRouteTable2": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        }
      }
    },
    "PrivateDefaultRoute1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1"
        }
      }
    },
    "PrivateDefaultRoute2": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable2"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway2"
        }
      }
    },
    "PrivateSubnet1Assoc": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PrivateSubnet1"
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1"
        }
      }
    },
    "PrivateSubnet2Assoc": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PrivateSubnet2"
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable2"
        }
      }
    },
    "ImagesBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${ImagesBucketName}-${AWS::AccountId}"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": false,
          "IgnorePublicAcls": false,
          "BlockPublicPolicy": false,
          "RestrictPublicBuckets": false
        },
        "CorsConfiguration": {
          "CorsRules": [
            {
              "AllowedMethods": [
                "GET",
                "PUT",
                "POST",
                "HEAD"
              ],
              "AllowedOrigins": [
                "*"
              ],
              "AllowedHeaders": [
                "*"
              ],
              "MaxAge": 3000
            }
          ]
        }
      }
    },
    "ImagesBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "ImagesBucket"
        },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": [
                "s3:GetObject"
              ],
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:s3:::${ImagesBucketName}-${AWS::AccountId}/*"
                }
              ]
            }
          ]
        }
      }
    },
    "WebBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${WebBucketName}-${AWS::AccountId}"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "IgnorePublicAcls": true,
          "BlockPublicPolicy": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "EcsTaskRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${ProjectName}-ecs-task-role"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "UploadImagesToS3",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "WriteImages",
                  "Effect": "Allow",
                  "Action": [
                    "s3:PutObject",
                    "s3:AbortMultipartUpload",
                    "s3:ListBucketMultipartUploads",
                    "s3:ListMultipartUploadParts"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${ImagesBucketName}-${AWS::AccountId}/*"
                    }
                  ]
                },
                {
                  "Sid": "ListImagesBucket",
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${ImagesBucketName}-${AWS::AccountId}"
                    }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "GitHubOidcProvider": {
      "Type": "AWS::IAM::OIDCProvider",
      "Properties": {
        "Url": "https://token.actions.githubusercontent.com",
        "ClientIdList": [
          "sts.amazonaws.com"
        ],
        "ThumbprintList": [
          "6938fd4d98bab03faadb97b34396831e3780aea1"
        ]
      }
    },
    "GitHubDeployRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${ProjectName}-github-deploy"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Federated": {
                  "Ref": "GitHubOidcProvider"
                }
              },
              "Action": "sts:AssumeRoleWithWebIdentity",
              "Condition": {
                "StringEquals": {
                  "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                  "token.actions.githubusercontent.com:sub": {
                    "Fn::Sub": "repo:${GitHubOrg}/${GitHubRepo}:ref:refs/heads/${GitHubBranch}"
                  }
                }
              }
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "DeployWebToS3AndInvalidateCF",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "S3WriteWeb",
                  "Effect": "Allow",
                  "Action": [
                    "s3:PutObject",
                    "s3:DeleteObject",
                    "s3:ListBucket",
                    "s3:GetBucketLocation"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${WebBucketName}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::${WebBucketName}-${AWS::AccountId}/*"
                    }
                  ]
                },
                {
                  "Sid": "InvalidateCloudFront",
                  "Effect": "Allow",
                  "Action": [
                    "cloudfront:CreateInvalidation"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:cloudfront::${AWS::AccountId}:distribution/${WebDistribution}"
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "EcrPushAndEcsDeploy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "EcrAuth",
                  "Effect": "Allow",
                  "Action": [
                    "ecr:GetAuthorizationToken"
                  ],
                  "Resource": "*"
                },
                {
                  "Sid": "EcrPushPull",
                  "Effect": "Allow",
                  "Action": [
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:BatchGetImage",
                    "ecr:CompleteLayerUpload",
                    "ecr:GetDownloadUrlForLayer",
                    "ecr:InitiateLayerUpload",
                    "ecr:PutImage",
                    "ecr:UploadLayerPart"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:ecr:${EcrRegion}:${AWS::AccountId}:repository/${ProjectName}-${ServiceAName}-images"
                    },
                    {
                      "Fn::Sub": "arn:aws:ecr:${EcrRegion}:${AWS::AccountId}:repository/${ProjectName}-${ServiceBName}-images"
                    },
                    {
                      "Fn::Sub": "arn:aws:ecr:${EcrRegion}:${AWS::AccountId}:repository/${ProjectName}-${ServiceCName}-images"
                    },
                    {
                      "Fn::Sub": "arn:aws:ecr:${EcrRegion}:${AWS::AccountId}:repository/${ProjectName}-${ServiceDName}-images"
                    }
                  ]
                },
                {
                  "Sid": "EcsDeploy",
                  "Effect": "Allow",
                  "Action": [
                    "ecs:DescribeClusters",
                    "ecs:DescribeServices",
                    "ecs:DescribeTaskDefinition",
                    "ecs:ListTasks",
                    "ecs:RegisterTaskDefinition",
                    "ecs:UpdateService"
                  ],
                  "Resource": "*"
                },
                {
                  "Sid": "AllowPassEcsRoles",
                  "Effect": "Allow",
                  "Action": [
                    "iam:PassRole"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn"
                      ]
                    }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "DbSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "Private subnets for RDS",
        "SubnetIds": [
          {
            "Ref": "PrivateSubnet1"
          },
          {
            "Ref": "PrivateSubnet2"
          }
        ]
      }
    },
    "DbSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "RDS Postgres SG (ingress from ECS SG added later).",
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "Db1": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "postgres",
        "DBInstanceIdentifier": {
          "Fn::Sub": "${ProjectName}-db1"
        },
        "DBInstanceClass": {
          "Ref": "DbInstanceClass"
        },
        "AllocatedStorage": {
          "Ref": "DbAllocatedStorage"
        },
        "DBSubnetGroupName": {
          "Ref": "DbSubnetGroup"
        },
        "VPCSecurityGroups": [
          {
            "Ref": "DbSecurityGroup"
          }
        ],
        "MasterUsername": {
          "Ref": "DbUsername"
        },
        "MasterUserPassword": {
          "Ref": "DbPassword"
        },
        "BackupRetentionPeriod": 7,
        "MultiAZ": {
          "Fn::If": [
            "IsMultiAZ",
            true,
            false
          ]
        },
        "StorageEncrypted": true,
        "PubliclyAccessible": false,
        "DeletionProtection": false
      }
    },
    "Db2": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "postgres",
        "DBInstanceIdentifier": {
          "Fn::Sub": "${ProjectName}-db2"
        },
        "DBInstanceClass": {
          "Ref": "DbInstanceClass"
        },
        "AllocatedStorage": {
          "Ref": "DbAllocatedStorage"
        },
        "DBSubnetGroupName": {
          "Ref": "DbSubnetGroup"
        },
        "VPCSecurityGroups": [
          {
            "Ref": "DbSecurityGroup"
          }
        ],
        "MasterUsername": {
          "Ref": "DbUsername"
        },
        "MasterUserPassword": {
          "Ref": "DbPassword"
        },
        "BackupRetentionPeriod": 7,
        "MultiAZ": {
          "Fn::If": [
            "IsMultiAZ",
            true,
            false
          ]
        },
        "StorageEncrypted": true,
        "PubliclyAccessible": false,
        "DeletionProtection": false
      }
    },
    "Db3": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "postgres",
        "DBInstanceIdentifier": {
          "Fn::Sub": "${ProjectName}-db3"
        },
        "DBInstanceClass": {
          "Ref": "DbInstanceClass"
        },
        "AllocatedStorage": {
          "Ref": "DbAllocatedStorage"
        },
        "DBSubnetGroupName": {
          "Ref": "DbSubnetGroup"
        },
        "VPCSecurityGroups": [
          {
            "Ref": "DbSecurityGroup"
          }
        ],
        "MasterUsername": {
          "Ref": "DbUsername"
        },
        "MasterUserPassword": {
          "Ref": "DbPassword"
        },
        "BackupRetentionPeriod": 7,
        "MultiAZ": {
          "Fn::If": [
            "IsMultiAZ",
            true,
            false
          ]
        },
        "StorageEncrypted": true,
        "PubliclyAccessible": false,
        "DeletionProtection": false
      }
    },
    "AlbSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "ALB SG allow inbound HTTP (80) from internet.",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "EcsSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "ECS tasks SG allow inbound from ALB only.",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": {
              "Ref": "ContainerPort"
            },
            "ToPort": {
              "Ref": "ContainerPort"
            },
            "SourceSecurityGroupId": {
              "Ref": "AlbSecurityGroup"
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "DbIngressFromEcs": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {
          "Ref": "DbSecurityGroup"
        },
        "IpProtocol": "tcp",
        "FromPort": {
          "Ref": "DbPort"
        },
        "ToPort": {
          "Ref": "DbPort"
        },
        "SourceSecurityGroupId": {
          "Ref": "EcsSecurityGroup"
        }
      }
    },
    "Alb": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Type": "application",
        "Scheme": "internet-facing",
        "Subnets": [
          {
            "Ref": "PublicSubnet1"
          },
          {
            "Ref": "PublicSubnet2"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "AlbSecurityGroup"
          }
        ]
      }
    },
    "AlbListenerHttp": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": {
          "Ref": "Alb"
        },
        "Port": 80,
        "Protocol": "HTTP",
        "DefaultActions": [
          {
            "Type": "fixed-response",
            "FixedResponseConfig": {
              "StatusCode": "404",
              "ContentType": "text/plain",
              "MessageBody": "Not found"
            }
          }
        ]
      }
    },
    "TargetGroupA": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "TargetType": "ip",
        "Port": {
          "Ref": "ContainerPort"
        },
        "Protocol": "HTTP",
        "HealthCheckPath": {
          "Ref": "HealthCheckPath"
        },
        "Matcher": {
          "HttpCode": "200-399"
        }
      }
    },
    "TargetGroupB": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "TargetType": "ip",
        "Port": {
          "Ref": "ContainerPort"
        },
        "Protocol": "HTTP",
        "HealthCheckPath": {
          "Ref": "HealthCheckPath"
        },
        "Matcher": {
          "HttpCode": "200-399"
        }
      }
    },
    "TargetGroupC": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "TargetType": "ip",
        "Port": {
          "Ref": "ContainerPort"
        },
        "Protocol": "HTTP",
        "HealthCheckPath": {
          "Ref": "HealthCheckPath"
        },
        "Matcher": {
          "HttpCode": "200-399"
        }
      }
    },
    "TargetGroupD": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "TargetType": "ip",
        "Port": {
          "Ref": "ContainerPort"
        },
        "Protocol": "HTTP",
        "HealthCheckPath": {
          "Ref": "HealthCheckPath"
        },
        "Matcher": {
          "HttpCode": "200-399"
        }
      }
    },
    "RuleA": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "AlbListenerHttp"
        },
        "Priority": 10,
        "Conditions": [
          {
            "Field": "path-pattern",
            "Values": {
              "Ref": "ServiceAPaths"
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroupA"
            }
          }
        ]
      }
    },
    "RuleB": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "AlbListenerHttp"
        },
        "Priority": 20,
        "Conditions": [
          {
            "Field": "path-pattern",
            "Values": {
              "Ref": "ServiceBPaths"
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroupB"
            }
          }
        ]
      }
    },
    "RuleC": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "AlbListenerHttp"
        },
        "Priority": 30,
        "Conditions": [
          {
            "Field": "path-pattern",
            "Values": {
              "Ref": "ServiceCPaths"
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroupC"
            }
          }
        ]
      }
    },
    "RuleD": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "AlbListenerHttp"
        },
        "Priority": 40,
        "Conditions": [
          {
            "Field": "path-pattern",
            "Values": {
              "Ref": "ServiceDPaths"
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroupD"
            }
          }
        ]
      }
    },
    "EcsCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Fn::Sub": "${ProjectName}-cluster"
        }
      }
    },
    "EcsExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${ProjectName}-ecs-exec-role"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ]
      }
    },
    "LogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/ecs/${ProjectName}"
        },
        "RetentionInDays": 14
      }
    },
    "ServiceDiscoveryNamespace": {
      "Type": "AWS::ServiceDiscovery::PrivateDnsNamespace",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}.local"
        },
        "Vpc": {
          "Ref": "Vpc"
        }
      }
    },
    "RedisDiscoveryService": {
      "Type": "AWS::ServiceDiscovery::Service",
      "Properties": {
        "Name": "redis",
        "NamespaceId": {
          "Ref": "ServiceDiscoveryNamespace"
        },
        "DnsConfig": {
          "DnsRecords": [
            {
              "TTL": 10,
              "Type": "A"
            }
          ],
          "RoutingPolicy": "MULTIVALUE"
        },
        "HealthCheckCustomConfig": {
          "FailureThreshold": 1
        }
      }
    },
    "KafkaDiscoveryService": {
      "Type": "AWS::ServiceDiscovery::Service",
      "Properties": {
        "Name": "kafka",
        "NamespaceId": {
          "Ref": "ServiceDiscoveryNamespace"
        },
        "DnsConfig": {
          "DnsRecords": [
            {
              "TTL": 10,
              "Type": "A"
            }
          ],
          "RoutingPolicy": "MULTIVALUE"
        },
        "HealthCheckCustomConfig": {
          "FailureThreshold": 1
        }
      }
    },
    "RedisSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "Redis SG: allow inbound 6379 from ECS tasks only",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 6379,
            "ToPort": 6379,
            "SourceSecurityGroupId": {
              "Ref": "EcsSecurityGroup"
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "KafkaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "Kafka SG: allow inbound 9092/9093 from ECS tasks only",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 9092,
            "ToPort": 9092,
            "SourceSecurityGroupId": {
              "Ref": "EcsSecurityGroup"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 9093,
            "ToPort": 9093,
            "SourceSecurityGroupId": {
              "Ref": "EcsSecurityGroup"
            }
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "RedisTaskDef": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {
          "Fn::Sub": "${ProjectName}-redis"
        },
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Memory": "512",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "redis",
            "Image": "redis:7",
            "PortMappings": [
              {
                "ContainerPort": 6379,
                "Protocol": "tcp"
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "redis"
              }
            }
          }
        ]
      }
    },
    "RedisService": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [
        "EcsCluster",
        "LogGroup"
      ],
      "Properties": {
        "ServiceName": {
          "Fn::Sub": "${ProjectName}-redis"
        },
        "Cluster": {
          "Ref": "EcsCluster"
        },
        "LaunchType": "FARGATE",
        "DesiredCount": 1,
        "TaskDefinition": {
          "Ref": "RedisTaskDef"
        },
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              }
            ],
            "SecurityGroups": [
              {
                "Ref": "RedisSecurityGroup"
              }
            ]
          }
        },
        "ServiceRegistries": [
          {
            "RegistryArn": {
              "Fn::GetAtt": [
                "RedisDiscoveryService",
                "Arn"
              ]
            }
          }
        ]
      }
    },
    "KafkaTaskDef": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {
          "Fn::Sub": "${ProjectName}-kafka"
        },
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "1024",
        "Memory": "2048",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "kafka",
            "Image": "apache/kafka:4.0.0",
            "PortMappings": [
              {
                "ContainerPort": 9092,
                "Protocol": "tcp"
              },
              {
                "ContainerPort": 9093,
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "KAFKA_PROCESS_ROLES",
                "Value": "broker,controller"
              },
              {
                "Name": "KAFKA_CONTROLLER_LISTENER_NAMES",
                "Value": "CONTROLLER"
              },
              {
                "Name": "KAFKA_LISTENERS",
                "Value": "PLAINTEXT://:9092,CONTROLLER://:9093"
              },
              {
                "Name": "KAFKA_LISTENER_SECURITY_PROTOCOL_MAP",
                "Value": "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
              },
              {
                "Name": "KAFKA_ADVERTISED_LISTENERS",
                "Value": {
                  "Fn::Sub": "PLAINTEXT://kafka.${ProjectName}.local:9092"
                }
              },
              {
                "Name": "KAFKA_CONTROLLER_QUORUM_VOTERS",
                "Value": {
                  "Fn::Sub": "1@kafka.${ProjectName}.local:9093"
                }
              },
              {
                "Name": "KAFKA_NODE_ID",
                "Value": "1"
              },
              {
                "Name": "KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR",
                "Value": "1"
              },
              {
                "Name": "KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR",
                "Value": "1"
              },
              {
                "Name": "KAFKA_TRANSACTION_STATE_LOG_MIN_ISR",
                "Value": "1"
              },
              {
                "Name": "KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS",
                "Value": "0"
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "kafka"
              }
            }
          }
        ]
      }
    },
    "KafkaService": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [
        "EcsCluster",
        "LogGroup"
      ],
      "Properties": {
        "ServiceName": {
          "Fn::Sub": "${ProjectName}-kafka"
        },
        "Cluster": {
          "Ref": "EcsCluster"
        },
        "LaunchType": "FARGATE",
        "DesiredCount": 1,
        "TaskDefinition": {
          "Ref": "KafkaTaskDef"
        },
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              }
            ],
            "SecurityGroups": [
              {
                "Ref": "KafkaSecurityGroup"
              }
            ]
          }
        },
        "ServiceRegistries": [
          {
            "RegistryArn": {
              "Fn::GetAtt": [
                "KafkaDiscoveryService",
                "Arn"
              ]
            }
          }
        ]
      }
    },
    "TaskDefA": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {
          "Fn::Sub": "${ProjectName}-service-${ServiceAName}"
        },
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Memory": "512",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn"
          ]
        },
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "app",
            "Image": {
              "Fn::If": [
                "IsBootstrapMode",
                {
                  "Ref": "BootstrapImage"
                },
                {
                  "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/${ProjectName}-${ServiceAName}-images:${ImageTag}"
                }
              ]
            },
            "PortMappings": [
              {
                "ContainerPort": {
                  "Ref": "ContainerPort"
                },
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "DB_HOST",
                "Value": {
                  "Fn::GetAtt": [
                    "Db1",
                    "Endpoint.Address"
                  ]
                }
              },
              {
                "Name": "DB_PORT",
                "Value": {
                  "Fn::Sub": "${DbPort}"
                }
              },
              {
                "Name": "DATA_SOURCE_URL",
                "Value": {
                  "Fn::Sub": [
                    "jdbc:postgresql://${DBHost}:${DBPort}/postgres",
                    {
                      "DBHost": {
                        "Fn::GetAtt": [
                          "Db1",
                          "Endpoint.Address"
                        ]
                      },
                      "DBPort": {
                        "Ref": "DbPort"
                      }
                    }
                  ]
                }
              },
              {
                "Name": "DATA_SOURCE_USERNAME",
                "Value": {
                  "Ref": "DbUsername"
                }
              },
              {
                "Name": "DATA_SOURCE_PASSWORD",
                "Value": {
                  "Ref": "DbPassword"
                }
              },
              {
                "Name": "AWS_BUCKET_NAME",
                "Value": {
                  "Fn::Sub": "${ImagesBucketName}-${AWS::AccountId}"
                }
              },
              {
                "Name": "MAIL_HOST",
                "Value": {
                  "Ref": "MailHost"
                }
              },
              {
                "Name": "MAIL_USERNAME",
                "Value": {
                  "Ref": "MailUsername"
                }
              },
              {
                "Name": "MAIL_PASSWORD",
                "Value": {
                  "Ref": "MailPassword"
                }
              },
              {
                "Name": "REDIS_HOST",
                "Value": {
                  "Fn::Sub": "redis.${ProjectName}.local"
                }
              },
              {
                "Name": "REDIS_PORT",
                "Value": "6379"
              },
              {
                "Name": "KAFKA_BOOTSTRAP_SERVERS",
                "Value": {
                  "Fn::Sub": "kafka.${ProjectName}.local:9092"
                }
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "service-${ServiceAName}"
              }
            }
          }
        ]
      }
    },
    "TaskDefB": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {
          "Fn::Sub": "${ProjectName}-service-${ServiceBName}"
        },
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Memory": "512",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn"
          ]
        },
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "app",
            "Image": {
              "Fn::If": [
                "IsBootstrapMode",
                {
                  "Ref": "BootstrapImage"
                },
                {
                  "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/${ProjectName}-${ServiceBName}-images:${ImageTag}"
                }
              ]
            },
            "PortMappings": [
              {
                "ContainerPort": {
                  "Ref": "ContainerPort"
                },
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "DB_HOST",
                "Value": {
                  "Fn::GetAtt": [
                    "Db2",
                    "Endpoint.Address"
                  ]
                }
              },
              {
                "Name": "DB_PORT",
                "Value": {
                  "Fn::Sub": "${DbPort}"
                }
              },
              {
                "Name": "DATA_SOURCE_URL",
                "Value": {
                  "Fn::Sub": [
                    "jdbc:postgresql://${DBHost}:${DBPort}/postgres",
                    {
                      "DBHost": {
                        "Fn::GetAtt": [
                          "Db2",
                          "Endpoint.Address"
                        ]
                      },
                      "DBPort": {
                        "Ref": "DbPort"
                      }
                    }
                  ]
                }
              },
              {
                "Name": "MAIL_HOST",
                "Value": {
                  "Ref": "MailHost"
                }
              },
              {
                "Name": "MAIL_USERNAME",
                "Value": {
                  "Ref": "MailUsername"
                }
              },
              {
                "Name": "MAIL_PASSWORD",
                "Value": {
                  "Ref": "MailPassword"
                }
              },
              {
                "Name": "DATA_SOURCE_USERNAME",
                "Value": {
                  "Ref": "DbUsername"
                }
              },
              {
                "Name": "DATA_SOURCE_PASSWORD",
                "Value": {
                  "Ref": "DbPassword"
                }
              },
              {
                "Name": "AWS_BUCKET_NAME",
                "Value": {
                  "Fn::Sub": "${ImagesBucketName}-${AWS::AccountId}"
                }
              },
              {
                "Name": "REDIS_HOST",
                "Value": {
                  "Fn::Sub": "redis.${ProjectName}.local"
                }
              },
              {
                "Name": "REDIS_PORT",
                "Value": "6379"
              },
              {
                "Name": "KAFKA_BOOTSTRAP_SERVERS",
                "Value": {
                  "Fn::Sub": "kafka.${ProjectName}.local:9092"
                }
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "service-${ServiceBName}"
              }
            }
          }
        ]
      }
    },
    "TaskDefC": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {
          "Fn::Sub": "${ProjectName}-service-${ServiceCName}"
        },
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Memory": "512",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn"
          ]
        },
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "app",
            "Image": {
              "Fn::If": [
                "IsBootstrapMode",
                {
                  "Ref": "BootstrapImage"
                },
                {
                  "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/${ProjectName}-${ServiceCName}-images:${ImageTag}"
                }
              ]
            },
            "PortMappings": [
              {
                "ContainerPort": {
                  "Ref": "ContainerPort"
                },
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "DB_HOST",
                "Value": {
                  "Fn::GetAtt": [
                    "Db2",
                    "Endpoint.Address"
                  ]
                }
              },
              {
                "Name": "DB_PORT",
                "Value": {
                  "Fn::Sub": "${DbPort}"
                }
              },
              {
                "Name": "DATA_SOURCE_URL",
                "Value": {
                  "Fn::Sub": [
                    "jdbc:postgresql://${DBHost}:${DBPort}/postgres",
                    {
                      "DBHost": {
                        "Fn::GetAtt": [
                          "Db2",
                          "Endpoint.Address"
                        ]
                      },
                      "DBPort": {
                        "Ref": "DbPort"
                      }
                    }
                  ]
                }
              },
              {
                "Name": "DATA_SOURCE_USERNAME",
                "Value": {
                  "Ref": "DbUsername"
                }
              },
              {
                "Name": "DATA_SOURCE_PASSWORD",
                "Value": {
                  "Ref": "DbPassword"
                }
              },
              {
                "Name": "AWS_BUCKET_NAME",
                "Value": {
                  "Fn::Sub": "${ImagesBucketName}-${AWS::AccountId}"
                }
              },
              {
                "Name": "MAIL_HOST",
                "Value": {
                  "Ref": "MailHost"
                }
              },
              {
                "Name": "MAIL_USERNAME",
                "Value": {
                  "Ref": "MailUsername"
                }
              },
              {
                "Name": "MAIL_PASSWORD",
                "Value": {
                  "Ref": "MailPassword"
                }
              },
              {
                "Name": "REDIS_HOST",
                "Value": {
                  "Fn::Sub": "redis.${ProjectName}.local"
                }
              },
              {
                "Name": "REDIS_PORT",
                "Value": "6379"
              },
              {
                "Name": "KAFKA_BOOTSTRAP_SERVERS",
                "Value": {
                  "Fn::Sub": "kafka.${ProjectName}.local:9092"
                }
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "service-${ServiceCName}"
              }
            }
          }
        ]
      }
    },
    "TaskDefD": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {
          "Fn::Sub": "${ProjectName}-service-${ServiceDName}"
        },
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Memory": "512",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn"
          ]
        },
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "app",
            "Image": {
              "Fn::If": [
                "IsBootstrapMode",
                {
                  "Ref": "BootstrapImage"
                },
                {
                  "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/${ProjectName}-${ServiceDName}-images:${ImageTag}"
                }
              ]
            },
            "PortMappings": [
              {
                "ContainerPort": {
                  "Ref": "ContainerPort"
                },
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "DB_HOST",
                "Value": {
                  "Fn::GetAtt": [
                    "Db3",
                    "Endpoint.Address"
                  ]
                }
              },
              {
                "Name": "DB_PORT",
                "Value": {
                  "Fn::Sub": "${DbPort}"
                }
              },
              {
                "Name": "DATA_SOURCE_URL",
                "Value": {
                  "Fn::Sub": [
                    "jdbc:postgresql://${DBHost}:${DBPort}/postgres",
                    {
                      "DBHost": {
                        "Fn::GetAtt": [
                          "Db3",
                          "Endpoint.Address"
                        ]
                      },
                      "DBPort": {
                        "Ref": "DbPort"
                      }
                    }
                  ]
                }
              },
              {
                "Name": "DATA_SOURCE_USERNAME",
                "Value": {
                  "Ref": "DbUsername"
                }
              },
              {
                "Name": "DATA_SOURCE_PASSWORD",
                "Value": {
                  "Ref": "DbPassword"
                }
              },
              {
                "Name": "AWS_BUCKET_NAME",
                "Value": {
                  "Fn::Sub": "${ImagesBucketName}-${AWS::AccountId}"
                }
              },
              {
                "Name": "MAIL_HOST",
                "Value": {
                  "Ref": "MailHost"
                }
              },
              {
                "Name": "MAIL_USERNAME",
                "Value": {
                  "Ref": "MailUsername"
                }
              },
              {
                "Name": "MAIL_PASSWORD",
                "Value": {
                  "Ref": "MailPassword"
                }
              },
              {
                "Name": "REDIS_HOST",
                "Value": {
                  "Fn::Sub": "redis.${ProjectName}.local"
                }
              },
              {
                "Name": "REDIS_PORT",
                "Value": "6379"
              },
              {
                "Name": "KAFKA_BOOTSTRAP_SERVERS",
                "Value": {
                  "Fn::Sub": "kafka.${ProjectName}.local:9092"
                }
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "service-${ServiceDName}"
              }
            }
          }
        ]
      }
    },
    "ServiceA": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [
        "AlbListenerHttp",
        "RuleA",
        "EcrRepoA"
      ],
      "Properties": {
        "ServiceName": {
          "Fn::Sub": "${ProjectName}-service-${ServiceAName}"
        },
        "Cluster": {
          "Ref": "EcsCluster"
        },
        "LaunchType": "FARGATE",
        "DesiredCount": {
          "Ref": "DesiredCountA"
        },
        "TaskDefinition": {
          "Ref": "TaskDefA"
        },
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              }
            ],
            "SecurityGroups": [
              {
                "Ref": "EcsSecurityGroup"
              }
            ]
          }
        },
        "LoadBalancers": [
          {
            "TargetGroupArn": {
              "Ref": "TargetGroupA"
            },
            "ContainerName": "app",
            "ContainerPort": {
              "Ref": "ContainerPort"
            }
          }
        ]
      }
    },
    "ServiceB": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [
        "AlbListenerHttp",
        "RuleB",
        "EcrRepoB"
      ],
      "Properties": {
        "ServiceName": {
          "Fn::Sub": "${ProjectName}-service-${ServiceBName}"
        },
        "Cluster": {
          "Ref": "EcsCluster"
        },
        "LaunchType": "FARGATE",
        "DesiredCount": {
          "Ref": "DesiredCountB"
        },
        "TaskDefinition": {
          "Ref": "TaskDefB"
        },
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              }
            ],
            "SecurityGroups": [
              {
                "Ref": "EcsSecurityGroup"
              }
            ]
          }
        },
        "LoadBalancers": [
          {
            "TargetGroupArn": {
              "Ref": "TargetGroupB"
            },
            "ContainerName": "app",
            "ContainerPort": {
              "Ref": "ContainerPort"
            }
          }
        ]
      }
    },
    "ServiceC": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [
        "AlbListenerHttp",
        "RuleC",
        "EcrRepoC"
      ],
      "Properties": {
        "ServiceName": {
          "Fn::Sub": "${ProjectName}-service-${ServiceCName}"
        },
        "Cluster": {
          "Ref": "EcsCluster"
        },
        "LaunchType": "FARGATE",
        "DesiredCount": {
          "Ref": "DesiredCountC"
        },
        "TaskDefinition": {
          "Ref": "TaskDefC"
        },
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              }
            ],
            "SecurityGroups": [
              {
                "Ref": "EcsSecurityGroup"
              }
            ]
          }
        },
        "LoadBalancers": [
          {
            "TargetGroupArn": {
              "Ref": "TargetGroupC"
            },
            "ContainerName": "app",
            "ContainerPort": {
              "Ref": "ContainerPort"
            }
          }
        ]
      }
    },
    "ServiceD": {
      "Type": "AWS::ECS::Service",
      "DependsOn": [
        "AlbListenerHttp",
        "RuleD",
        "EcrRepoD"
      ],
      "Properties": {
        "ServiceName": {
          "Fn::Sub": "${ProjectName}-service-${ServiceDName}"
        },
        "Cluster": {
          "Ref": "EcsCluster"
        },
        "LaunchType": "FARGATE",
        "DesiredCount": {
          "Ref": "DesiredCountD"
        },
        "TaskDefinition": {
          "Ref": "TaskDefD"
        },
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              }
            ],
            "SecurityGroups": [
              {
                "Ref": "EcsSecurityGroup"
              }
            ]
          }
        },
        "LoadBalancers": [
          {
            "TargetGroupArn": {
              "Ref": "TargetGroupD"
            },
            "ContainerName": "app",
            "ContainerPort": {
              "Ref": "ContainerPort"
            }
          }
        ]
      }
    },
    "AutoScalingRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${ProjectName}-appautoscaling-role"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "application-autoscaling.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceAutoscaleRole"
        ]
      }
    },
    "ScalableTargetA": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": {
          "Ref": "AutoScaleMax"
        },
        "MinCapacity": {
          "Ref": "AutoScaleMin"
        },
        "ResourceId": {
          "Fn::Sub": "service/${EcsCluster}/${ServiceA.Name}"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "AutoScalingRole",
            "Arn"
          ]
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    "ScalingPolicyA": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": {
          "Fn::Sub": "${ProjectName}-cpu-a"
        },
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "ScalableTargetA"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": {
            "Ref": "AutoScaleCpuTarget"
          },
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60
        }
      }
    },
    "ScalableTargetB": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": {
          "Ref": "AutoScaleMax"
        },
        "MinCapacity": {
          "Ref": "AutoScaleMin"
        },
        "ResourceId": {
          "Fn::Sub": "service/${EcsCluster}/${ServiceB.Name}"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "AutoScalingRole",
            "Arn"
          ]
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    "ScalingPolicyB": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": {
          "Fn::Sub": "${ProjectName}-cpu-b"
        },
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "ScalableTargetB"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": {
            "Ref": "AutoScaleCpuTarget"
          },
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60
        }
      }
    },
    "ScalableTargetC": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": {
          "Ref": "AutoScaleMax"
        },
        "MinCapacity": {
          "Ref": "AutoScaleMin"
        },
        "ResourceId": {
          "Fn::Sub": "service/${EcsCluster}/${ServiceC.Name}"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "AutoScalingRole",
            "Arn"
          ]
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    "ScalingPolicyC": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": {
          "Fn::Sub": "${ProjectName}-cpu-c"
        },
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "ScalableTargetC"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": {
            "Ref": "AutoScaleCpuTarget"
          },
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60
        }
      }
    },
    "ScalableTargetD": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": {
          "Ref": "AutoScaleMax"
        },
        "MinCapacity": {
          "Ref": "AutoScaleMin"
        },
        "ResourceId": {
          "Fn::Sub": "service/${EcsCluster}/${ServiceD.Name}"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "AutoScalingRole",
            "Arn"
          ]
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    "ScalingPolicyD": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": {
          "Fn::Sub": "${ProjectName}-cpu-d"
        },
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "ScalableTargetD"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": {
            "Ref": "AutoScaleCpuTarget"
          },
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60
        }
      }
    },
    "ApiSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc"
        },
        "GroupDescription": "API Gateway VPC Link SG: allow egress, and ALB allows inbound from this SG.",
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "AlbIngressFromApiGw": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {
          "Ref": "AlbSecurityGroup"
        },
        "IpProtocol": "tcp",
        "FromPort": 80,
        "ToPort": 80,
        "SourceSecurityGroupId": {
          "Ref": "ApiSecurityGroup"
        }
      }
    },
    "HttpApi": {
      "Type": "AWS::ApiGatewayV2::Api",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-http-api"
        },
        "ProtocolType": "HTTP"
      }
    },
    "VpcLink": {
      "Type": "AWS::ApiGatewayV2::VpcLink",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-vpc-link"
        },
        "SubnetIds": [
          {
            "Ref": "PrivateSubnet1"
          },
          {
            "Ref": "PrivateSubnet2"
          }
        ],
        "SecurityGroupIds": [
          {
            "Ref": "ApiSecurityGroup"
          }
        ]
      }
    },
    "ApiIntegrationToAlb": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApi"
        },
        "IntegrationType": "HTTP_PROXY",
        "IntegrationMethod": "ANY",
        "IntegrationUri": {
          "Ref": "AlbListenerHttp"
        },
        "ConnectionType": "VPC_LINK",
        "ConnectionId": {
          "Ref": "VpcLink"
        },
        "PayloadFormatVersion": "1.0"
      }
    },
    "ApiRouteAny": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApi"
        },
        "RouteKey": "ANY /{proxy+}",
        "Target": {
          "Fn::Sub": "integrations/${ApiIntegrationToAlb}"
        }
      }
    },
    "ApiStage": {
      "Type": "AWS::ApiGatewayV2::Stage",
      "Properties": {
        "ApiId": {
          "Ref": "HttpApi"
        },
        "StageName": "$default",
        "AutoDeploy": true
      }
    },
    "WebOac": {
      "Type": "AWS::CloudFront::OriginAccessControl",
      "Properties": {
        "OriginAccessControlConfig": {
          "Name": {
            "Fn::Sub": "${ProjectName}-web-oac"
          },
          "OriginAccessControlOriginType": "s3",
          "SigningBehavior": "always",
          "SigningProtocol": "sigv4"
        }
      }
    },
    "WebDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Enabled": true,
          "DefaultRootObject": "index.html",
          "HttpVersion": "http2",
          "Origins": [
            {
              "Id": "webS3Origin",
              "DomainName": {
                "Fn::GetAtt": [
                  "WebBucket",
                  "RegionalDomainName"
                ]
              },
              "OriginAccessControlId": {
                "Ref": "WebOac"
              },
              "S3OriginConfig": {}
            }
          ],
          "DefaultCacheBehavior": {
            "TargetOriginId": "webS3Origin",
            "ViewerProtocolPolicy": "redirect-to-https",
            "AllowedMethods": [
              "GET",
              "HEAD",
              "OPTIONS"
            ],
            "CachedMethods": [
              "GET",
              "HEAD",
              "OPTIONS"
            ],
            "Compress": true,
            "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6"
          },
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html"
            },
            {
              "ErrorCode": 404,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html"
            }
          ]
        }
      }
    },
    "WebBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "WebBucket"
        },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowCloudFrontServicePrincipalReadOnly",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": [
                "s3:GetObject"
              ],
              "Resource": [
                {
                  "Fn::Sub": "arn:aws:s3:::${WebBucketName}-${AWS::AccountId}/*"
                }
              ],
              "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": {
                    "Fn::Sub": "arn:aws:cloudfront::${AWS::AccountId}:distribution/${WebDistribution}"
                  }
                }
              }
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "HttpApiEndpoint": {
      "Value": {
        "Fn::GetAtt": [
          "HttpApi",
          "ApiEndpoint"
        ]
      }
    },
    "S3BucketFe": {
      "Value": {
        "Ref": "WebBucket"
      }
    },
    "CloudFrontDomain": {
      "Value": {
        "Fn::GetAtt": [
          "WebDistribution",
          "DomainName"
        ]
      }
    },
    "CloudFrontDistributionId": {
      "Value": {
        "Ref": "WebDistribution"
      }
    },
    "GitHubDeployRoleArn": {
      "Value": {
        "Fn::GetAtt": [
          "GitHubDeployRole",
          "Arn"
        ]
      }
    },
    "EcsClusterName": {
      "Value": {
        "Ref": "EcsCluster"
      }
    },
    "EcsServiceAName": {
      "Value": {
        "Ref": "ServiceA"
      }
    },
    "EcsServiceBName": {
      "Value": {
        "Ref": "ServiceB"
      }
    },
    "EcsServiceCName": {
      "Value": {
        "Ref": "ServiceC"
      }
    },
    "EcsServiceDName": {
      "Value": {
        "Ref": "ServiceD"
      }
    },
    "EcrRepoAName": {
      "Value": {
        "Ref": "EcrRepoA"
      }
    },
    "EcrRepoBName": {
      "Value": {
        "Ref": "EcrRepoB"
      }
    },
    "EcrRepoCName": {
      "Value": {
        "Ref": "EcrRepoC"
      }
    },
    "EcrRepoDName": {
      "Value": {
        "Ref": "EcrRepoD"
      }
    }
  }
}